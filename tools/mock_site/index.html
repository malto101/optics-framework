
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optics API Tester</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; }
    .container { max-width: 900px; margin: 2em auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 2em; }
    h1 { text-align: center; }
    .row { display: flex; gap: 2em; }
    .column { flex: 1; }
    .form-group { margin-bottom: 1em; }
    label { display: block; margin-bottom: 0.3em; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 0.5em; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 0.5em 1.5em; border: none; border-radius: 4px; background: #007bff; color: #fff; font-weight: bold; cursor: pointer; margin-top: 0.5em; }
    button:disabled { background: #aaa; }
    .response { background: #f0f0f0; border-radius: 4px; padding: 1em; margin-top: 1em; font-size: 0.95em; white-space: pre-wrap; }
    .img-preview { max-width: 100%; border: 1px solid #ccc; margin-top: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Optics API Tester</h1>
    <div class="row">
      <div class="column">
        <h2>Session Controls</h2>
        <form id="session-form">
          <div class="form-group">
            <label>Driver Sources (comma separated)</label>
            <input type="text" id="driver_sources" value="appium">
          </div>
          <div class="form-group">
            <label>Elements Sources (comma separated)</label>
            <input type="text" id="elements_sources" value="appium_find_element,appium_screenshot">
          </div>
          <div class="form-group">
            <label>Appium URL</label>
            <input type="text" id="appium_url" value="http://localhost:4723">
          </div>
          <div class="form-group">
            <label>Appium Config (JSON)</label>
            <textarea id="appium_config" rows="5">{
  "appActivity": "com.android.contacts.activities.PeopleActivity",
  "appPackage": "com.google.android.contacts",
  "automationName": "UiAutomator2",
  "deviceName": "emulator-5554",
  "platformName": "Android"
}</textarea>
          </div>
          <button type="button" onclick="startSession()">Start Session</button>
          <button type="button" onclick="stopSession()">Stop Session</button>
        </form>
        <div class="form-group">
          <label>Session ID</label>
          <input type="text" id="session_id" readonly>
        </div>
      </div>
      <div class="column">
        <h2>API Actions</h2>
        <form id="keyword-form">
          <div class="form-group">
            <label>Keyword</label>
            <input type="text" id="keyword" value="capture_screenshot">
          </div>
          <div class="form-group">
            <label>Params (comma separated)</label>
            <input type="text" id="params" value="">
          </div>
          <button type="button" onclick="executeKeyword()">Execute Keyword</button>
        </form>
        <button type="button" onclick="getScreenshot()">Get Screenshot</button>
        <button type="button" onclick="getElements()">Get Elements</button>
        <button type="button" onclick="getPageSource()">Get Page Source</button>
        <button type="button" onclick="getScreenElements()">Get Screen Elements</button>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <h2>Response</h2>
        <div id="response" class="response"></div>
      </div>
      <div class="column">
        <h2>Screenshot Preview</h2>
        <img id="screenshot-img" class="img-preview" src="" alt="Screenshot will appear here">
      </div>
    </div>
  </div>
  <script>
  let sessionId = '';
  let previousSessionId = '';
    function showResponse(data) {
      document.getElementById('response').textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }
    function logRequest(url, options) {
      console.log('API Request:', url, options);
    }
    function logResponse(url, response) {
      console.log('API Response from', url, response);
    }
    // Use the correct API base URL for all requests
    const API_BASE = 'http://localhost:8000';

    function startSession() {
      previousSessionId = sessionId;
      const driver_sources = document.getElementById('driver_sources').value.split(',').map(s => s.trim());
      const elements_sources = document.getElementById('elements_sources').value.split(',').map(s => s.trim());
      const appium_url = document.getElementById('appium_url').value;
      let appium_config = {};
      try { appium_config = JSON.parse(document.getElementById('appium_config').value); } catch(e) { showResponse('Invalid Appium Config JSON'); return; }
      const url = `${API_BASE}/v1/sessions/start`;
      const options = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ driver_sources, elements_sources, appium_url, appium_config })
      };
      logRequest(url, options);
      fetch(url, options)
      .then(res => res.json())
      .then(data => {
        logResponse(url, data);
        if (data.session_id) {
          sessionId = data.session_id;
          document.getElementById('session_id').value = sessionId;
        }
        showResponse(data);
      })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
    function stopSession() {
      if (!sessionId) { showResponse('No session started'); return; }
      const url = `${API_BASE}/v1/sessions/${sessionId}/stop`;
      const options = { method: 'DELETE' };
      logRequest(url, options);
      fetch(url, options)
      .then(res => res.json())
      .then(data => {
        logResponse(url, data);
        showResponse(data);
        previousSessionId = sessionId;
        sessionId = '';
        document.getElementById('session_id').value = '';
        document.getElementById('screenshot-img').src = '';
      })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
    function executeKeyword() {
      if (!sessionId) { showResponse('No session started'); return; }
      const keyword = document.getElementById('keyword').value;
      const params = document.getElementById('params').value.split(',').map(s => s.trim()).filter(Boolean);
      const url = `${API_BASE}/v1/sessions/${sessionId}/action`;
      const options = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode: 'keyword', keyword, params })
      };
      logRequest(url, options);
      fetch(url, options)
      .then(res => res.json())
      .then(data => { logResponse(url, data); showResponse(data); })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
    function getScreenshot() {
      if (!sessionId) { showResponse('No session started'); return; }
      const url = `${API_BASE}/session/${sessionId}/screenshot`;
      logRequest(url, {});
      fetch(url)
      .then(res => res.json())
      .then(data => {
        logResponse(url, data);
        showResponse(data);
        if (data.data && data.data.result && data.data.result.screenshot) {
          document.getElementById('screenshot-img').src = 'data:image/png;base64,' + data.data.result.screenshot;
        } else {
          document.getElementById('screenshot-img').src = '';
        }
      })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
    function getElements() {
      if (!sessionId) { showResponse('No session started'); return; }
      const url = `${API_BASE}/session/${sessionId}/elements`;
      logRequest(url, {});
      fetch(url)
      .then(res => res.json())
      .then(data => { logResponse(url, data); showResponse(data); })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
    function getPageSource() {
      if (!sessionId) { showResponse('No session started'); return; }
      const url = `${API_BASE}/session/${sessionId}/source`;
      logRequest(url, {});
      fetch(url)
      .then(res => res.json())
      .then(data => { logResponse(url, data); showResponse(data); })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
    function getScreenElements() {
      if (!sessionId) { showResponse('No session started'); return; }
      const url = `${API_BASE}/session/${sessionId}/screen_elements`;
      logRequest(url, {});
      fetch(url)
      .then(res => res.json())
      .then(data => { logResponse(url, data); showResponse(data); })
      .catch(err => { logResponse(url, err); showResponse(err); });
    }
  </script>
</body>
</html>
